<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fl.web.dao.sd.IOrderItemDao">

    <resultMap type="TOrderItem" id="orderItemMap">
        <result property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="itemNo" column="item_no"/>
        <result property="maktl" column="maktl"/>
        <result property="maktlName" column="maktlName"/>
        <result property="matnr" column="matnr"/>
        <result property="maktx" column="maktx"/>
        <result property="norms" column="norms"/>
        <result property="unit" column="unit"/>
        <result property="manufacturer" column="manufacturer"/>
        <result property="qualityType" column="quality_type"/>
        <result property="price" column="price"/>
        <result property="num" column="num"/>
        <result property="deliveryNum" column="delivery_num"/>
        <result property="usableNum" column="usable_num"/>
        <result property="money" column="money"/>
        <result property="reqId" column="req_id"/>
        <result property="deliveryState" column="delivery_state"/>
        <result property="status" column="status"/>
        <result property="createBy" column="create_by"/>
        <result property="createDate" column="create_date"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateDate" column="update_date"/>

        <result property="censorFlag" column="censorFlag"/>
        <result property="companyCode" column="company_code"/>
        <result property="company" column="company"/>
        <result property="supplierCode" column="supplier_code"/>
        <result property="supplierName" column="supplier_name"/>
        <result property="orderDate" column="order_date"/>
        <result property="projectCode" column="project_code"/>
        <result property="projectName" column="projectName"/>
        <result property="arrivalDate" column="arrival_date"/>
        <result property="reqDept" column="req_dept"/>
        <result property="reqName" column="req_name"/>
        <result property="purchaser" column="purchaser"/>

    </resultMap>

    <insert id="saveOrderItemBatch" parameterType="java.util.List">
        insert into order_item
        (id,order_no,item_no,maktl,matnr,maktx,norms,unit,manufacturer,quality_type,price,num,
        delivery_num,usable_num,money,req_id,delivery_state,status,create_by,create_date)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.id},#{item.orderNo},#{item.itemNo},#{item.maktl},#{item.matnr},#{item.maktx},#{item.norms},#{item.unit},
            #{item.manufacturer},#{item.qualityType},#{item.price},#{item.num},#{item.deliveryNum},#{item.usableNum},
            #{item.money},#{item.reqId},#{item.deliveryState},#{item.status},#{item.createBy},#{item.createDate})
        </foreach>
    </insert>

    <select id="getOrderItemByOrderNo" resultMap="orderItemMap" parameterType="java.lang.String">
        select
        t.id,
        t.order_no,
        t.item_no,
        t.maktl,
        mt.name maktlName,
        t.matnr,
        t.maktx,
        t.norms,
        t.unit,
        t.manufacturer,
        t.quality_type,
        t.price,
        t.num,
        t.money,
        t.req_id,
        t.delivery_num,
        t.delivery_state
        from order_item t
        left join mara_type mt on t.maktl = mt.maktl
        where t.status!='003' and t.order_no=#{_parameter}
        order by t.item_no
    </select>

    <select id="getOrderItemById" resultType="TOrderItem" parameterType="java.lang.String">
        select
        t.id,
        t.order_no,
        t.item_no,
        t.maktl,
        mt.name maktlName,
        t.matnr,
        t.maktx,
        t.norms,
        t.unit,
        t.manufacturer,
        t.quality_type,
        t.num,
        t.delivery_num deliveryNum,
        t.req_id
        from order_item t
        left join mara_type mt on t.maktl = mt.maktl
        where t.status!='003' and t.id=#{_parameter}
    </select>

    <update id="updateOrderItemBatch" parameterType="java.util.List">
        <foreach close="" collection="list" index="index" item="item" open="" separator=";">
            update order_item
            set price=#{item.price},money=#{item.money}
            where id=#{item.id}
        </foreach>
    </update>

    <select id="queryWaitDeliveryList" parameterType="OrderItem" resultMap="orderItemMap">
        select
        oi.id,
        oi.req_id,
        oh.order_no,
        oi.item_no,
        oh.company_code,
        oh.company,
        oh.supplier_code,
        oh.supplier_name,
        oh.order_date,
        oh.project_code,
        d.name projectName,
        oh.req_dept,
        oh.req_name,
        oh.purchaser,
        oi.maktl,
        mt.name maktlName,
        oi.matnr,
        oi.maktx,
        oi.norms,
        oi.unit,
        oi.manufacturer,
        oi.quality_type,
        q.flag censorFlag,
        oi.num,
        oi.delivery_num,
        oi.usable_num
        from
        order_head oh
        inner join order_item oi on oh.order_no = oi.order_no
        left join data_dictionary d on oh.project_code=d.code and group_code='HC008'
        left join mara_type mt on oi.maktl=mt.maktl
        left join quality_info q on q.code=oi.quality_type
        where oh.status!='003' and oh.order_status in ('20','21') and oi.delivery_state in ('-2','-1')
        <if test="supplierCode != null">
            and oh.supplier_code like #{supplierCode}
        </if>
        <if test="supplierName != null">
            and oh.supplier_name like #{supplierName}
        </if>
        <if test="orderNo != null">
            and oh.order_no like #{orderNo}
        </if>
        <if test="companyCode != null">
            and oh.company_code = #{companyCode}
        </if>
        <if test="projectCode != null">
            and oh.project_code = #{projectCode}
        </if>
        order by oh.order_no,oi.item_no
    </select>

    <update id="updateItemDeliveryInfo" parameterType="java.util.List">
        <foreach close="" collection="list" index="index" item="item" open="" separator=";">
            update order_item
            <trim prefix="set" suffixOverrides=",">
                <if test="item.usableNum != null">
                    usable_num=usable_num - #{item.usableNum},
                </if>
                <if test="item.usableNum != null">
                    delivery_num=delivery_num + #{item.usableNum},
                </if>
                <if test="item.deliveryState != null">
                    delivery_state=#{item.deliveryState},
                </if>
                <if test="item.status != null">
                    status = #{item.status},
                </if>
                <if test="item.updateBy != null">
                    update_by = #{item.updateBy},
                </if>
                <if test="item.updateDate != null">
                    update_date = #{item.updateDate},
                </if>
            </trim>
            <where>
                id = #{item.id}
            </where>
        </foreach>
    </update>

    <update id="updateItemDeliveryNum" parameterType="TOrderItem">
        update order_item
        <trim prefix="set" suffixOverrides=",">
            <if test="usableNum != null">
                usable_num=usable_num + #{usableNum},
            </if>
            <if test="usableNum != null">
                delivery_num=delivery_num - #{usableNum},
            </if>
            <if test="deliveryState != null">
                delivery_state=#{deliveryState},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate},
            </if>
        </trim>
        <where>
            id = #{id}
        </where>
    </update>


    <update id="updateItemDeliveryDiff" parameterType="java.util.Map">
        update order_item
        <trim prefix="SET" suffixOverrides=",">
            <if test="deliveryState != null">
                delivery_state = #{deliveryState},
            </if>
            <if test="note != null">
                delivery_note = #{note},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate},
            </if>
        </trim>
        <where>
            id in
            <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </where>
    </update>


</mapper>