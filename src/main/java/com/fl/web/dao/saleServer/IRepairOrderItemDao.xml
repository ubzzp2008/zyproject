<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fl.web.dao.saleServer.IRepairOrderItemDao">

    <resultMap type="TRepairOrderItem" id="reItemMap">
        <result property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="kunnr" column="kunnr"/>
        <result property="kunnrName" column="kunnrName"/>
        <result property="deviceSN" column="deviceSN"/>
        <result property="deviceName" column="deviceName"/>
        <result property="deviceNorms" column="deviceNorms"/>
        <result property="orderNo" column="order_no"/>
        <result property="itemNo" column="item_no"/>
        <result property="matnr" column="matnr"/>
        <result property="maktx" column="maktx"/>
        <result property="norms" column="norms"/>
        <result property="unit" column="unit"/>
        <result property="num" column="num"/>
        <result property="dealType" column="deal_type"/>
        <result property="dealName" column="dealName"/>
        <result property="dealState" column="deal_state"/>
        <result property="dealStateStr" column="dealStateStr"/>
        <result property="repairBy" column="repairBy"/>
        <result property="repairName" column="repairName"/>
        <result property="note" column="note"/>
        <result property="status" column="status"/>
        <result property="createBy" column="create_by"/>
        <result property="createDate" column="create_date"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateDate" column="update_date"/>
    </resultMap>

    <!--case when t.deal_state='0' then '审批中'
    when t.deal_state='5' then '退坏中'
    when t.deal_state='10' then '换新中'
    when t.deal_state='20' then '已完成'
    end as dealStateStr,-->
    <select id="getOrderItemByOrderNo" resultMap="reItemMap" parameterType="java.lang.String">
        select
                t.id,
                t.order_no,
                t.item_no,
                t.matnr,
                t.maktx,
                t.norms,
                t.unit,
                t.num,
                t.deal_type,
                d.name dealName,
                t.deal_state,
                case when t.deal_type in ('DT03','DT04','DT05','DT06') and rmo.mara_flag is null and rmn.mara_flag is null then '待审批方案'
                        when t.deal_type = 'DT03' then concat( '坏件:', d2.name )
                        when t.deal_type = 'DT04' then concat( '新件:', d1.name )
                        when t.deal_type = 'DT05' then concat( '新件:', d1.name )
                        when t.deal_type = 'DT06' then concat( '新件:', d1.name, '/坏件:', d2.name )
                        else '已完成'
                end as dealStateStr,
                t.note
        from repair_order_item t
        left join data_dictionary d on t.deal_type = d.code and d.group_code = 'HC003'
        left join repair_mara rmn on t.id = rmn.item_id and t.item_no = rmn.item_no and rmn.mara_flag = 'NEW'
        left join repair_mara rmo on t.id = rmo.item_id and t.item_no = rmo.item_no and rmo.mara_flag = 'OLD'
        left join data_dictionary d1 on rmn.state = d1.code and d1.group_code = 'HC004'
        left join data_dictionary d2 on rmo.state = d2.code and d2.group_code = 'HC004'
		where t.status!='003' and t.order_no=#{_parameter}
        order by t.item_no

    </select>

    <insert id="saveRepairOrderItem" parameterType="java.util.List">
        insert into repair_order_item
        (id,order_no,item_no,matnr,maktx,norms,unit,num,deal_type,deal_state,note,status,create_by,create_date) values
        <foreach collection="list" item="item" separator=",">
            (#{item.id},#{item.orderNo},#{item.itemNo},#{item.matnr},#{item.maktx},#{item.norms},#{item.unit},#{item.num},
            #{item.dealType},#{item.dealState},#{item.note},#{item.status},#{item.createBy},#{item.createDate})
        </foreach>
    </insert>

    <update id="updateOrderItemStatusBatch" parameterType="java.util.List">
        <foreach close="" collection="list" index="index" item="item" open="" separator=";">
            update repair_order_item
            set deal_state=#{item.dealState}
            where id=#{item.id}
        </foreach>
    </update>


    <select id="repairOrderDetailList" resultMap="reItemMap" parameterType="RepairOrderItem">
        SELECT
        t.id,
        t.order_no,
        t.kunnr,
        k.kunnr_name kunnrName,
        t.device_sn deviceSN,
        d.device_name deviceName,
        d.device_norms deviceNorms,
        ri.matnr,
        ri.maktx,
        ri.norms,
        ri.num,
        ri.unit,
        ri.deal_type,
        dic.name dealName,
        ri.note,
        t.receive_by repairBy,
        u.realname repairName
        from
        repair_order_head t
        inner join repair_order_item ri on t.order_no = ri.order_no
        inner join kunnr_device kd on t.kunnr = kd.kunnr
        and t.device_sn = kd.device_sn
        left join kunnr_info k on t.kunnr = k.kunnr
        and k.status != '003'
        left join device_info d on t.device_sn = d.device_sn
        and d.status != '003'
        left join t_user_info u on t.receive_by = u.username
        left join data_dictionary dic on ri.deal_type = dic.code
        and dic.group_code = 'HC003'
        where
        kd.id = #{kdId}
        and t.order_status in ( '30', '50' )
        <if test="orderNo != null">
            and t.order_no like #{orderNo}
        </if>
        <if test="matnr != null">
            and ri.matnr like #{matnr}
        </if>
        <if test="maktx != null">
            and ri.maktx like #{maktx}
        </if>
        order by t.order_no desc
    </select>

    <select id="queryRepairItemList" resultMap="reItemMap" parameterType="RepairOrderItem">
        SELECT
        t.id,
        t.order_no,
        t.kunnr,
        k.kunnr_name kunnrName,
        t.device_sn deviceSN,
        d.device_name deviceName,
        d.device_norms deviceNorms,
        ri.matnr,
        ri.maktx,
        ri.norms,
        ri.num,
        ri.unit,
        ri.deal_type,
        dic.name dealName,
        ri.note,
        t.receive_by repairBy,
        u.realname repairName
        from
        repair_order_head t
        inner join repair_order_item ri on t.order_no = ri.order_no
        inner join kunnr_device kd on t.kunnr = kd.kunnr
        and t.device_sn = kd.device_sn
        left join kunnr_info k on t.kunnr = k.kunnr
        and k.status != '003'
        left join device_info d on t.device_sn = d.device_sn
        and d.status != '003'
        left join t_user_info u on t.receive_by = u.username
        left join data_dictionary dic on ri.deal_type = dic.code
        and dic.group_code = 'HC003'
        where t.status!='003'
        <if test="deviceSN != null">
            and t.device_sn like #{deviceSN}
        </if>
        <if test="orderNo != null">
            and t.order_no like #{orderNo}
        </if>
        <if test="matnr != null">
            and ri.matnr like #{matnr}
        </if>
        <if test="maktx != null">
            and ri.maktx like #{maktx}
        </if>
        order by t.order_no desc
    </select>

</mapper>