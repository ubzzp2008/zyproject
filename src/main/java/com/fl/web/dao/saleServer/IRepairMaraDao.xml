<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fl.web.dao.saleServer.IRepairMaraDao">

    <resultMap type="TRepairMara" id="reMaraMap">
        <result property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="itemNo" column="item_no"/>
        <result property="itemId" column="item_id"/>
        <result property="matnr" column="matnr"/>
        <result property="maktx" column="maktx"/>
        <result property="norms" column="norms"/>
        <result property="unit" column="unit"/>
        <result property="num" column="num"/>
        <result property="repairBy" column="repair_by"/>
        <result property="state" column="state"/>
        <result property="maraFlag" column="mara_flag"/>
        <result property="expressWay" column="express_way"/>
        <result property="expressNum" column="express_num"/>
        <result property="receiver" column="receiver"/>
        <result property="address" column="address"/>
        <result property="sender" column="sender"/>
        <result property="sendDate" column="send_date"/>
        <result property="note" column="note"/>
        <result property="receiveMsgUser" column="receive_msg_user"/>
        <result property="status" column="status"/>
        <result property="createBy" column="create_by"/>
        <result property="createDate" column="create_date"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateDate" column="update_date"/>

        <result property="kunnr" column="kunnr"/>
        <result property="kunnrName" column="kunnrName"/>
        <result property="deviceSN" column="deviceSN"/>
        <result property="deviceName" column="deviceName"/>
        <result property="deviceNorms" column="deviceNorms"/>

    </resultMap>

    <select id="queryRepairMaraList" resultMap="reMaraMap" parameterType="RepairMara">
        SELECT
        t.id,
        t.order_no,
        t.item_no,
        t.item_id,
        t.matnr,
        t.maktx,
        t.norms,
        t.unit,
        t.num,
        t.repair_by,
        t.state,
        t.mara_flag,
        t.express_way,
        t.express_num,
        t.receiver,
        t.address,
        t.sender,
        t.send_date,
        t.note,
        t.receive_msg_user,
        t.create_by,
        t.create_date,
        rh.kunnr,
        k.kunnr_name kunnrName,
        rh.device_sn deviceSN,
        d.device_name deviceName,
        d.device_norms deviceNorms
        FROM
        repair_mara t left join repair_order_head rh on t.order_no=rh.order_no
        left join kunnr_info k on rh.kunnr=k.kunnr
        left join device_info d on rh.device_sn=d.device_sn
        where t.status!='003'
        <if test="repairBy != null and repairBy!='' ">
            and t.repair_by = #{repairBy}
        </if>
        <if test="state != null and state!='' ">
            and t.state = #{state}
        </if>
        <if test="maraFlag != null and maraFlag!='' ">
            and t.mara_flag = #{maraFlag}
        </if>
        <if test="orderNo != null">
            and t.order_no like #{orderNo}
        </if>
        <if test="kunnr != null">
            and rh.kunnr like #{kunnr}
        </if>
        <if test="kunnrName != null">
            and k.kunnr_name like #{kunnrName}
        </if>
        <if test="deviceSN != null">
            and rh.device_sn like #{deviceSN}
        </if>
        <if test="deviceName != null">
            and d.name like #{deviceName}
        </if>
        order by t.order_no,t.item_no desc
    </select>

    <insert id="saveRepairMaraBatch" parameterType="java.util.List">
        insert into repair_mara
        (id,order_no,item_no,item_id,matnr,maktx,norms,unit,num,repair_by,state,mara_flag,status,create_by,create_date)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.id},#{item.orderNo},#{item.itemNo},#{item.itemId},#{item.matnr},#{item.maktx},#{item.norms},#{item.unit},#{item.num},
            #{item.repairBy},#{item.state},#{item.maraFlag},#{item.status},#{item.createBy},#{item.createDate})
        </foreach>
    </insert>

    <update id="updateRepairMara" parameterType="java.util.Map">
        update repair_mara
        <trim prefix="SET" suffixOverrides=",">
            <if test="expressWay != null">
                express_way = #{expressWay},
            </if>
            <if test="expressNum != null">
                express_num = #{expressNum},
            </if>
            <if test="receiver != null">
                receiver = #{receiver},
            </if>
            <if test="address != null">
                address = #{address},
            </if>
            <if test="sender != null">
                sender = #{sender},
            </if>
            <if test="sendDate != null">
                send_date = #{sendDate},
            </if>
            <if test="note != null">
                note = #{note},
            </if>
            <if test="state != null">
                state = #{state},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate},
            </if>
            <if test="receiveMsgUser != null">
                receive_msg_user = #{receiveMsgUser},
            </if>
        </trim>
        <where>
            id in
            <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </where>
    </update>


    <select id="getRepairMaraByOrderNoList" parameterType="java.util.List" resultMap="reMaraMap">
        SELECT
        t.id,
        t.order_no,
        t.item_no,
        t.item_id,
        t.matnr,
        t.maktx,
        t.norms,
        t.unit,
        t.num
        FROM
        repair_mara t
        where t.status!='003' and t.mara_flag='NEW' and t.order_no in
        <foreach collection="list" item="orderNo" index="index" open="(" close=")" separator=",">
            #{orderNo}
        </foreach>
    </select>

</mapper>