<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fl.web.dao.saleServer.IRepairOrderHeadDao">

    <resultMap type="TRepairOrderHead" id="reHeadMap">
        <result property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="kunnr" column="kunnr"/>
        <result property="kunnrName" column="kunnr_name"/>
        <result property="address" column="address"/>
        <result property="contactInfo" column="contact_info"/>
        <result property="contactTel" column="contact_tel"/>
        <result property="deviceSN" column="device_sn"/>
        <result property="deviceName" column="device_name"/>
        <result property="deviceNorms" column="device_norms"/>
        <result property="reportName" column="report_name"/>
        <result property="reportDate" column="report_date"/>
        <result property="reportTel" column="report_tel"/>
        <result property="faultNote" column="fault_note"/>
        <result property="orderStatus" column="order_status"/>
        <result property="orderStatusStr" column="orderStatusStr"/>
        <result property="note" column="note"/>
        <result property="receiveBy" column="receive_by"/>
        <result property="receiveName" column="receiveName"/>
        <result property="empCode" column="empCode"/>
        <result property="status" column="status"/>
        <result property="createBy" column="create_by"/>
        <result property="createDate" column="create_date"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateDate" column="update_date"/>
    </resultMap>

    <!--维修单单据查询
        <if test="deptPos != null">
            and ( t.receive_by = #{receiveBy} or t.create_by=#{receiveBy})
        </if>
     -->
    <select id="queryRepairOrderList" resultMap="reHeadMap" parameterType="RepairOrderHead">
        SELECT
        t.id,
        t.order_no,
        t.kunnr,
        k.kunnr_name,
        k.address,
        k.contact_info,
        k.contact_tel,
        t.device_sn,
        d.device_name ,
        d.device_norms ,
        t.report_name,
        t.report_date,
        t.report_tel,
        t.fault_note,
        t.order_status,
        dic.name orderStatusStr,
        t.note,
        t.receive_by,
        u.emp_code empCode,
        u.realname receiveName,
        t.create_by,
        t.create_date,
        t.update_by,
        t.update_date
        FROM
        repair_order_head t
        LEFT JOIN kunnr_info k on t.kunnr=k.kunnr and k.status!='003'
        left join device_info d on t.device_sn=d.device_sn and d.status!='003'
        left join t_user_info u on t.receive_by=u.username and u.status!='003'
        left join data_dictionary dic on t.order_status=dic.code and dic.group_code='HC002'
        where t.status!='003'
        <if test="receiveBy != null and receiveBy!='' ">
            and ( t.receive_by = #{receiveBy} or t.create_by=#{receiveBy})
        </if>
        <if test="orderStatus != null and orderStatus!='' ">
            and t.order_status = #{orderStatus}
        </if>
        <if test="orderNo != null">
            and t.order_no like #{orderNo}
        </if>
        <if test="kunnr != null">
            and t.kunnr like #{kunnr}
        </if>
        <if test="kunnrName != null">
            and k.kunnr_name like #{kunnrName}
        </if>
        <if test="deviceSN != null">
            and t.device_sn like #{deviceSN}
        </if>
        <if test="deviceName != null">
            and d.device_name like #{deviceName}
        </if>
        <if test="deviceNorms != null">
            and d.device_norms like #{deviceNorms}
        </if>
        <if test="userNameList!=null and userNameList.size() > 0">
            and t.create_by in
            <foreach collection="userNameList" item="userName" index="index" open="(" separator="," close=")">
                #{userName}
            </foreach>
        </if>
        order by t.order_no desc
    </select>

    <!--维修日志查询-->
    <select id="repairOrderByKunnrList" resultMap="reHeadMap" parameterType="RepairOrderHead">
        SELECT
        t.id,
        t.order_no,
        t.kunnr,
        k.kunnr_name,
        k.address,
        k.contact_info,
        k.contact_tel,
        t.device_sn,
        d.device_name,
        d.device_norms,
        t.report_name,
        t.report_date,
        t.report_tel,
        t.fault_note,
        t.order_status,
        dic.name orderStatusStr,
        t.note,
        t.receive_by,
        u.realname receiveName,
        t.create_by,
        t.create_date,
        t.update_by,
        t.update_date
        FROM
        repair_order_head t inner join kunnr_device kd on t.kunnr=kd.kunnr and t.device_sn=kd.device_sn
        LEFT JOIN kunnr_info k on t.kunnr=k.kunnr and k.status!='003'
        left join device_info d on t.device_sn=d.device_sn and d.status!='003'
        left join t_user_info u on t.receive_by=u.username and u.status!='003'
        left join data_dictionary dic on t.order_status=dic.code and dic.group_code='HC002'
        where kd.id=#{kdId} and t.order_status in ('30','50') and t.status!='003' and kd.status!='003'
        <if test="orderNo != null">
            and t.order_no like #{orderNo}
        </if>
        order by t.order_no desc
    </select>

    <insert id="saveRepairOrderHead" parameterType="TRepairOrderHead">
        insert into repair_order_head (id,order_no,kunnr,device_sn,report_name,report_date,report_tel,
                            fault_note,order_status,note,create_by,create_date,status)
        values (#{id}, #{orderNo},#{kunnr},#{deviceSN},#{reportName},#{reportDate},#{reportTel},
                            #{faultNote},#{orderStatus},#{note},#{createBy},#{createDate},#{status})
    </insert>

    <update id="updateRepairOrderStatusBatch" parameterType="java.util.Map">
        update repair_order_head
        <trim prefix="SET" suffixOverrides=",">
            <if test="receiveBy != null">
                receive_by = #{receiveBy},
            </if>
            <if test="orderStatus != null">
                order_status = #{orderStatus},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate},
            </if>
        </trim>
        <where>
            id in
            <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </where>
    </update>


    <update id="updateRepairOrderStatusById" parameterType="java.util.Map">
        update repair_order_head
        <trim prefix="SET" suffixOverrides=",">
            <if test="orderStatus != null">
                order_status = #{orderStatus},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate},
            </if>
        </trim>
        <where>
            id =#{id}
        </where>
    </update>

    <!--<update id="toBackRepairOrder" parameterType="java.util.Map">
        update repair_order_head set receive_by='',order_status=#{orderStatus} where id in
        <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>-->
    <update id="toBackRepairOrder" parameterType="java.util.Map">
        update repair_order_head set receive_by='',order_status=#{orderStatus}
        where id=#{id}
    </update>


    <select id="findDataByIdAndStatus" parameterType="java.util.Map" resultMap="reHeadMap">
        select t.id,t.order_no,t.kunnr,t.device_sn
        FROM repair_order_head t
        where t.status!='003' and t.order_status!=#{orderStatus} and t.id in
        <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="getOrderHeadByOrderNo" parameterType="java.lang.String" resultType="TRepairOrderHead">
        SELECT
        t.id,
        t.order_no orderNo,
        t.kunnr,
        k.kunnr_name kunnrName,
        k.address,
        k.contact_info contactInfo,
        k.contact_tel contactTel,
        t.device_sn deviceSN,
        d.device_name deviceName,
        d.device_norms deviceNorms,
        t.report_name reportName,
        t.report_date reportDate,
        t.report_tel reportTel,
        t.fault_note faultNote,
        t.order_status orderStatus,
        dic.name orderStatusStr,
        t.receive_by receiveBy,
        u.realname receiveName,
        t.note
        FROM
        repair_order_head t
        LEFT JOIN kunnr_info k on t.kunnr=k.kunnr and k.status!='003'
        left join device_info d on t.device_sn=d.device_sn and d.status!='003'
        left join data_dictionary dic on t.order_status=dic.code and dic.group_code='HC002'
        left join t_user_info u on t.receive_by=u.username
        where t.status!='003' and t.order_no=#{_parameter}
    </select>

    <select id="getOrderHeadById" parameterType="java.lang.String" resultType="TRepairOrderHead">
        SELECT
        t.id,
        t.order_no orderNo,
        t.kunnr,
        k.kunnr_name kunnrName,
        k.address,
        k.contact_info contactInfo,
        k.contact_tel contactTel,
        t.device_sn deviceSN,
        d.device_name deviceName,
        d.device_norms deviceNorms,
        t.report_name reportName,
        t.report_date reportDate,
        t.report_tel reportTel,
        t.fault_note faultNote,
        t.order_status orderStatus,
        dic.name orderStatusStr,
        t.receive_by receiveBy,
        t.note
        FROM
        repair_order_head t
        LEFT JOIN kunnr_info k on t.kunnr=k.kunnr and k.status!='003'
        left join device_info d on t.device_sn=d.device_sn and d.status!='003'
        left join data_dictionary dic on t.order_status=dic.code and dic.group_code='HC002'
        where t.status!='003' and t.id=#{_parameter}
    </select>

</mapper>