<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fl.web.dao.qm.IMaraCensorDao">

    <resultMap type="TMaraCensor" id="maraCensorMap">
        <result property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="companyCode" column="companyCode"/>
        <result property="company" column="company"/>
        <result property="supplierCode" column="supplierCode"/>
        <result property="supplierName" column="supplierName"/>
        <result property="orderDate" column="orderDate"/>
        <result property="projectCode" column="projectCode"/>
        <result property="projectName" column="projectName"/>
        <result property="reqDept" column="reqDept"/>
        <result property="reqName" column="reqName"/>
        <result property="purchaser" column="purchaser"/>
        <result property="reqId" column="req_id"/>
        <result property="itemId" column="item_id"/>
        <result property="itemNo" column="item_no"/>
        <result property="maktl" column="maktl"/>
        <result property="maktlName" column="maktlName"/>
        <result property="matnr" column="matnr"/>
        <result property="maktx" column="maktx"/>
        <result property="norms" column="norms"/>
        <result property="unit" column="unit"/>
        <result property="receiveUser" column="receive_user"/>
        <result property="receiveDate" column="receive_date"/>
        <result property="num" column="num"/>
        <result property="unqualifiedNum" column="unqualified_num"/>
        <result property="qualifiedNum" column="qualified_num"/>
        <result property="reason" column="reason"/>
        <result property="qualityType" column="quality_type"/>
        <result property="generationDate" column="generation_date"/>
        <result property="validityDate" column="validity_date"/>
        <result property="manufacturer" column="manufacturer"/>
        <result property="checkUser" column="check_user"/>
        <result property="checkDate" column="check_date"/>
        <result property="state" column="state"/>
        <result property="deliveryId" column="delivery_id"/>
    </resultMap>

    <insert id="saveMaraCensorBatch" parameterType="java.util.List">
        insert into mara_censor
        (id,order_no,req_id,item_id,item_no,maktl,matnr,maktx,norms,unit,manufacturer,quality_type,num,state,delivery_id,status,create_by,create_date)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.id},#{item.orderNo},#{item.reqId},#{item.itemId},#{item.itemNo},#{item.maktl},#{item.matnr},#{item.maktx},#{item.norms},#{item.unit},
            #{item.manufacturer},#{item.qualityType},#{item.num},#{item.state},#{item.deliveryId},#{item.status},#{item.createBy},#{item.createDate})
        </foreach>
    </insert>


    <select id="queryMaraCensorList" resultMap="maraCensorMap" parameterType="MaraCensor">
        SELECT
        t.id,
        t.order_no,
        oh.company_code companyCode,
        oh.company,
        oh.supplier_code supplierCode,
        oh.supplier_name supplierName,
        oh.order_date orderDate,
        oh.project_code projectCode,
        d.name projectName,
        oh.req_dept reqDept,
        oh.req_name reqName,
        oh.purchaser,
        t.req_id,
        t.item_id,
        t.item_no,
        t.maktl,
        mt.NAME maktlName,
        t.matnr,
        t.maktx,
        t.norms,
        t.unit,
        t.receive_user,
        t.receive_date,
        t.num,
        ifnull(t.unqualified_num,0) unqualified_num,
        ifnull(t.qualified_num,0) qualified_num,
        t.quality_type,
        t.generation_date,
        t.validity_date,
        t.manufacturer,
        t.check_user,
        t.check_date,
        t.state,
        t.reason,
        t.delivery_id
        FROM
        mara_censor t
        left join order_head oh on oh.order_no=t.order_no
        left join mara_type mt on t.maktl = mt.maktl
        left join data_dictionary d on oh.project_code=d.code and d.group_code='HC008'
        WHERE
        t.status != '003'
        <if test="state != null and state!='' ">
            and t.state = #{state}
        </if>
        <if test="orderNo != null">
            and t.order_no like #{orderNo}
        </if>
        <if test="matnr != null">
            and t.matnr like #{matnr}
        </if>
        <if test="maktx != null">
            and t.maktx like #{maktx}
        </if>
        <if test="norms != null">
            and t.norms like #{norms}
        </if>
        order by t.order_no
    </select>

    <select id="findMaraCensorByIdList" resultMap="maraCensorMap" parameterType="java.util.List">
        SELECT
        t.id,
        t.order_no,
        oh.company_code companyCode,
        oh.company,
        oh.supplier_code supplierCode,
        oh.supplier_name supplierName,
        oh.order_date orderDate,
        oh.project_code projectCode,
        oh.req_dept reqDept,
        oh.req_name reqName,
        oh.purchaser,
        t.req_id,
        t.item_id,
        t.item_no,
        t.maktl,
        mt.NAME maktlName,
        t.matnr,
        t.maktx,
        t.norms,
        t.unit,
        t.receive_user,
        t.receive_date,
        t.num,
        ifnull(t.unqualified_num,0) unqualified_num,
        ifnull(t.qualified_num,0) qualified_num,
        t.quality_type,
        t.generation_date,
        t.validity_date,
        t.manufacturer,
        t.check_user,
        t.check_date,
        t.state,
        t.delivery_id
        FROM
        mara_censor t
        left join order_head oh on oh.order_no=t.order_no
        left join mara_type mt on t.maktl = mt.maktl
        where t.id in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
        and t.status != '003'
        order by t.order_no
    </select>

    <select id="checkCensorState" resultType="java.lang.Integer">
        select count(1) from mara_censor where id=#{id}  and state!=#{state} and status!='003'
    </select>

    <select id="checkCensorStateBatch" resultType="java.lang.Integer">
        select count(1) from mara_censor where id in
        <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
        and state!=#{state} and status!='003'
    </select>


    <update id="updateMaraCensor" parameterType="java.util.Map">
        update mara_censor
        <trim prefix="SET" suffixOverrides=",">
            <if test="state != null">
                state = #{state},
            </if>
            <if test="receiveUser != null">
                receive_user = #{receiveUser},
            </if>
            <if test="receiveDate != null">
                receive_date = #{receiveDate},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate},
            </if>
        </trim>
        <where>
            id in
            <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </where>
    </update>


    <update id="saveInspectResult" parameterType="java.util.List">
        <foreach close="" collection="list" index="index" item="item" open="" separator=";">
            update mara_censor
            <trim prefix="SET" suffixOverrides=",">
                <if test="item.state != null">
                    state = #{item.state},
                </if>
                <if test="item.checkUser != null">
                    check_user = #{item.checkUser},
                </if>
                <if test="item.checkDate != null">
                    check_date = #{item.checkDate},
                </if>
                <if test="item.unqualifiedNum != null">
                    unqualified_num=#{item.unqualifiedNum},
                </if>
                <if test="item.qualifiedNum != null">
                    qualified_num=#{item.qualifiedNum},
                </if>
                <if test="item.generationDate != null">
                    generation_date=#{item.generationDate},
                </if>
                <if test="item.validityDate != null">
                    validity_date=#{item.validityDate},
                </if>
                <if test="item.reason != null">
                    reason = #{item.reason},
                </if>
                <if test="item.status != null">
                    status = #{item.status},
                </if>
                <if test="item.updateBy != null">
                    update_by = #{item.updateBy},
                </if>
                <if test="item.updateDate != null">
                    update_date = #{item.updateDate},
                </if>
            </trim>
            <where>
                id = #{item.id}
            </where>
        </foreach>
    </update>


</mapper>